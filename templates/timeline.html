<!-- templates/timeline.html -->
{% extends 'base.html' %}

{% block title %}Timeline Search{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Search controls sidebar -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Timeline Search</h5>
                </div>
                <div class="card-body">
                    <form id="timeline-search-form">
                        <div class="mb-3">
                            <label for="query" class="form-label">Search Query</label>
                            <input type="text" class="form-control" id="query" name="q" placeholder="Enter search terms">
                        </div>

                        <div class="mb-3">
                            <label for="interval" class="form-label">Time Interval</label>
                            <select class="form-select" id="interval" name="interval">
                                <option value="day">Daily</option>
                                <option value="week">Weekly</option>
                                <option value="month" selected>Monthly</option>
                                <option value="year">Yearly</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="platform" class="form-label">Platform</label>
                            <select class="form-select" id="platform" name="platform">
                                <option value="">All Platforms</option>
                                <option value="netflix">Netflix</option>
                                <option value="disney+">Disney+</option>
                                <option value="hbo max">HBO Max</option>
                                <option value="amazon prime">Amazon Prime</option>
                                <option value="hulu">Hulu</option>
                                <option value="apple tv+">Apple TV+</option>
                                <option value="peacock">Peacock</option>
                                <option value="paramount+">Paramount+</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="sentiment" class="form-label">Sentiment</label>
                            <select class="form-select" id="sentiment" name="sentiment">
                                <option value="">All Sentiments</option>
                                <option value="positive">Positive</option>
                                <option value="negative">Negative</option>
                                <option value="neutral">Neutral</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Date Range</label>
                            <div class="row">
                                <div class="col">
                                    <input type="date" class="form-control" id="start_date" name="start_date" placeholder="Start Date">
                                </div>
                                <div class="col">
                                    <input type="date" class="form-control" id="end_date" name="end_date" placeholder="End Date">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Generate Timeline</button>
                    </form>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Topics to Track</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="price increase" id="topic1" checked>
                        <label class="form-check-label" for="topic1">
                            Price Increases
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="content quality" id="topic2" checked>
                        <label class="form-check-label" for="topic2">
                            Content Quality
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="technical issues" id="topic3" checked>
                        <label class="form-check-label" for="topic3">
                            Technical Issues
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="user interface" id="topic4" checked>
                        <label class="form-check-label" for="topic4">
                            User Interface
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="customer service" id="topic5">
                        <label class="form-check-label" for="topic5">
                            Customer Service
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="cancel subscription" id="topic6">
                        <label class="form-check-label" for="topic6">
                            Cancellations
                        </label>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Timeline Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" id="find-peak-periods">Find Peak Periods</button>
                        <button type="button" class="btn btn-outline-primary" id="find-sentiment-shifts">Find Sentiment Shifts</button>
                        <button type="button" class="btn btn-outline-primary" id="platform-comparison">Platform Comparison</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline visualization area -->
        <div class="col-md-9">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0" id="timeline-title">Timeline Visualization</h4>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-light" id="export-image">Export Image</button>
                        <button type="button" class="btn btn-sm btn-light" id="export-data">Export Data</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="timeline-loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Generating timeline visualization...</p>
                    </div>
                    <div id="timeline-container" style="height: 500px;"></div>
                </div>
            </div>

            <div class="row">
                <!-- Sentiment timeline -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Sentiment Over Time</h5>
                        </div>
                        <div class="card-body">
                            <div id="sentiment-timeline-container" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Platform timeline -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Platform Comparison</h5>
                        </div>
                        <div class="card-body">
                            <div id="platform-timeline-container" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Topic trends -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Topic Trends</h5>
                </div>
                <div class="card-body">
                    <div id="topic-timeline-container" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Analysis results -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Analysis Results</h5>
                </div>
                <div class="card-body">
                    <div id="analysis-results">
                        <p class="text-muted">Run an analysis to see results here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Hide loading indicator initially
        $('#timeline-loading').hide();

        // Initialize date range with defaults
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);

        $('#end_date').val(today.toISOString().split('T')[0]);
        $('#start_date').val(oneYearAgo.toISOString().split('T')[0]);

        // Initialize Plotly.js
        function createEmptyPlot(containerId, message = "No data available") {
            const container = document.getElementById(containerId);
            Plotly.newPlot(container, [{
                x: [],
                y: [],
                type: 'scatter'
            }], {
                annotations: [{
                    text: message,
                    showarrow: false,
                    font: { size: 16 }
                }]
            });
        }

        // Create empty plots initially
        createEmptyPlot('timeline-container', 'Use the search form to generate a timeline');
        createEmptyPlot('sentiment-timeline-container', 'Sentiment data will appear here');
        createEmptyPlot('platform-timeline-container', 'Platform comparison will appear here');
        createEmptyPlot('topic-timeline-container', 'Topic trends will appear here');

        // Handle form submission
        $('#timeline-search-form').on('submit', function(e) {
            e.preventDefault();
            generateTimelineVisualizations();
        });

        // Handle analysis buttons
        $('#find-peak-periods').on('click', findPeakPeriods);
        $('#find-sentiment-shifts').on('click', findSentimentShifts);
        $('#platform-comparison').on('click', generatePlatformComparison);

        // Handle export buttons
        $('#export-image').on('click', function() {
            Plotly.downloadImage('timeline-container', {
                format: 'png',
                width: 1200,
                height: 800,
                filename: 'timeline_visualization'
            });
        });

        $('#export-data').on('click', function() {
            // Get current data from the plot
            const graphDiv = document.getElementById('timeline-container');
            const data = graphDiv.data;

            // Format data as CSV
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Count\n";

            if (data && data[0] && data[0].x && data[0].y) {
                for (let i = 0; i < data[0].x.length; i++) {
                    csvContent += data[0].x[i] + "," + data[0].y[i] + "\n";
                }
            }

            // Create download link and trigger click
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "timeline_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Function to generate timeline visualizations
        function generateTimelineVisualizations() {
            // Show loading indicator
            $('#timeline-loading').show();
            $('#timeline-container').hide();

            // Get form data
            const query = $('#query').val() || '*:*';
            const interval = $('#interval').val();
            const platform = $('#platform').val();
            const sentiment = $('#sentiment').val();
            const startDate = $('#start_date').val();
            const endDate = $('#end_date').val();

            // Update timeline title
            let title = 'Timeline: ';
            title += query !== '*:*' ? query : 'All Documents';
            if (platform) title += ` on ${platform}`;
            if (sentiment) title += ` with ${sentiment} sentiment`;
            $('#timeline-title').text(title);

            // Prepare filters
            const filters = [];
            if (platform) filters.push(`platform:${platform}`);
            if (sentiment) filters.push(`sentiment:${sentiment}`);
            if (startDate && endDate) {
                filters.push(`created_at:[${startDate}T00:00:00Z TO ${endDate}T23:59:59Z]`);
            }

            // API call to get timeline data
            $.ajax({
                url: '/api/timeline/dashboard',
                data: {
                    q: query,
                    interval: interval,
                    fq: filters
                },
                success: function(response) {
                    // Hide loading indicator
                    $('#timeline-loading').hide();
                    $('#timeline-container').show();

                    // Render the dashboard
                    document.getElementById('timeline-container').innerHTML = response.html;

                    // Get additional data for other charts
                    generateSentimentTimeline(query, interval, filters);
                    generatePlatformTimeline(interval, filters);
                    generateTopicTimeline(query, interval, filters);
                },
                error: function(xhr, status, error) {
                    // Hide loading indicator and show error
                    $('#timeline-loading').hide();
                    $('#timeline-container').show();
                    createEmptyPlot('timeline-container', 'Error loading timeline: ' + error);
                }
            });
        }

        // Function to generate sentiment timeline
        function generateSentimentTimeline(query, interval, filters) {
            $.ajax({
                url: '/api/timeline/sentiment',
                data: {
                    q: query,
                    interval: interval,
                    fq: filters
                },
                success: function(data) {
                    if (!data.dates || data.dates.length === 0) {
                        createEmptyPlot('sentiment-timeline-container', 'No sentiment data available');
                        return;
                    }

                    const traces = [];

                    // Add positive sentiment
                    if (data.positive) {
                        traces.push({
                            x: data.dates,
                            y: data.positive,
                            name: 'Positive',
                            type: 'scatter',
                            mode: 'lines+markers',
                            line: { color: 'green', width: 2 }
                        });
                    }

                    // Add negative sentiment
                    if (data.negative) {
                        traces.push({
                            x: data.dates,
                            y: data.negative,
                            name: 'Negative',
                            type: 'scatter',
                            mode: 'lines+markers',
                            line: { color: 'red', width: 2 }
                        });
                    }

                    // Add neutral sentiment
                    if (data.neutral) {
                        traces.push({
                            x: data.dates,
                            y: data.neutral,
                            name: 'Neutral',
                            type: 'scatter',
                            mode: 'lines+markers',
                            line: { color: 'gray', width: 2 }
                        });
                    }

                    const layout = {
                        title: 'Sentiment Distribution Over Time',
                        xaxis: { title: 'Date' },
                        yaxis: { title: 'Document Count' },
                        legend: { orientation: 'h', y: -0.2 },
                        hovermode: 'closest'
                    };

                    Plotly.newPlot('sentiment-timeline-container', traces, layout);
                },
                error: function(xhr, status, error) {
                    createEmptyPlot('sentiment-timeline-container', 'Error loading sentiment data: ' + error);
                }
            });
        }

        // Function to generate platform timeline
        function generatePlatformTimeline(interval, filters) {
            $.ajax({
                url: '/api/timeline/platforms',
                data: {
                    interval: interval,
                    fq: filters
                },
                success: function(data) {
                    if (!data.dates || data.dates.length === 0) {
                        createEmptyPlot('platform-timeline-container', 'No platform data available');
                        return;
                    }

                    const traces = [];
                    const platformColors = {
                        'netflix': '#E50914',
                        'disney+': '#113CCF',
                        'hulu': '#1CE783',
                        'amazon prime': '#00A8E1',
                        'hbo max': '#5822B4',
                        'apple tv+': '#000000',
                        'peacock': '#FFFFFF',
                        'paramount+': '#0064FF'
                    };

                    // Add trace for each platform
                    for (const platform in data) {
                        if (platform !== 'dates' && Array.isArray(data[platform])) {
                            traces.push({
                                x: data.dates,
                                y: data[platform],
                                name: platform,
                                type: 'scatter',
                                mode: 'lines+markers',
                                line: {
                                    color: platformColors[platform.toLowerCase()] || '#6c757d',
                                    width: 2
                                }
                            });
                        }
                    }

                    const layout = {
                        title: 'Platform Activity Over Time',
                        xaxis: { title: 'Date' },
                        yaxis: { title: 'Document Count' },
                        legend: { orientation: 'h', y: -0.2 },
                        hovermode: 'closest'
                    };

                    Plotly.newPlot('platform-timeline-container', traces, layout);
                },
                error: function(xhr, status, error) {
                    createEmptyPlot('platform-timeline-container', 'Error loading platform data: ' + error);
                }
            });
        }

        // Function to generate topic timeline
        function generateTopicTimeline(query, interval, filters) {
            // Get selected topics
            const topics = {};
            $('input[type=checkbox]:checked').each(function() {
                const topicValue = $(this).val();
                const topicName = $(this).next('label').text().trim();
                topics[topicName] = query !== '*:*' ?
                    `${query} AND ${topicValue}` : topicValue;
            });

            if (Object.keys(topics).length === 0) {
                createEmptyPlot('topic-timeline-container', 'No topics selected');
                return;
            }

            // For each topic, get timeline data
            const topicData = { dates: [] };
            let topicsLoaded = 0;
            const totalTopics = Object.keys(topics).length;

            for (const [topicName, topicQuery] of Object.entries(topics)) {
                $.ajax({
                    url: '/api/timeline/distribution',
                    data: {
                        q: topicQuery,
                        interval: interval,
                        fq: filters
                    },
                    success: function(data) {
                        if (data.timeline && data.timeline.length > 0) {
                            // Initialize dates if not set
                            if (topicData.dates.length === 0) {
                                topicData.dates = data.timeline.map(item => item.date);
                            }

                            // Add topic counts
                            topicData[topicName] = data.timeline.map(item => item.count);
                        }

                        // Check if all topics are loaded
                        topicsLoaded++;
                        if (topicsLoaded === totalTopics) {
                            renderTopicTimeline(topicData);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error(`Error loading data for ${topicName}: ${error}`);

                        // Check if all topics are loaded
                        topicsLoaded++;
                        if (topicsLoaded === totalTopics) {
                            renderTopicTimeline(topicData);
                        }
                    }
                });
            }
        }

        // Function to render topic timeline
        function renderTopicTimeline(topicData) {
            if (!topicData.dates || topicData.dates.length === 0) {
                createEmptyPlot('topic-timeline-container', 'No topic data available');
                return;
            }

            const traces = [];

            // Add trace for each topic
            for (const topic in topicData) {
                if (topic !== 'dates' && Array.isArray(topicData[topic])) {
                    traces.push({
                        x: topicData.dates,
                        y: topicData[topic],
                        name: topic,
                        type: 'scatter',
                        mode: 'lines+markers'
                    });
                }
            }

            const layout = {
                title: 'Topic Trends Over Time',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Document Count' },
                legend: { orientation: 'h', y: -0.2 },
                hovermode: 'closest'
            };

            Plotly.newPlot('topic-timeline-container', traces, layout);
        }

        // Function to generate platform comparison
        function generatePlatformComparison() {
            // Show loading indicator
            $('#analysis-results').html('<div class="text-center"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Generating platform comparison...</p></div>');

            // Get current parameters
            const interval = $('#interval').val();
            const startDate = $('#start_date').val();
            const endDate = $('#end_date').val();

            // Prepare filters
            const filters = [];
            if (startDate && endDate) {
                filters.push(`created_at:[${startDate}T00:00:00Z TO ${endDate}T23:59:59Z]`);
            }

            // Use the platform timeline data
            $.ajax({
                url: '/api/timeline/platforms',
                data: {
                    interval: interval,
                    fq: filters
                },
                success: function(data) {
                    if (!data.dates || data.dates.length === 0) {
                        $('#analysis-results').html('<div class="alert alert-warning">No platform data available</div>');
                        return;
                    }

                    // Calculate totals for each platform
                    const platformTotals = {};
                    for (const platform in data) {
                        if (platform !== 'dates' && Array.isArray(data[platform])) {
                            platformTotals[platform] = data[platform].reduce((sum, count) => sum + count, 0);
                        }
                    }

                    // Sort platforms by total volume
                    const sortedPlatforms = Object.entries(platformTotals)
                        .sort((a, b) => b[1] - a[1])
                        .map(entry => entry[0]);

                    // Generate comparison HTML
                    let html = '<h4>Platform Comparison</h4>';
                    html += '<p>Total document volume for each platform during the selected period:</p>';
                    html += '<div class="table-responsive"><table class="table table-striped">';
                    html += '<thead><tr><th>Platform</th><th>Total Documents</th><th>Percentage</th><th>Volume</th></tr></thead>';
                    html += '<tbody>';

                    const totalDocuments = Object.values(platformTotals).reduce((sum, count) => sum + count, 0);

                    for (const platform of sortedPlatforms) {
                        const count = platformTotals[platform];
                        const percentage = ((count / totalDocuments) * 100).toFixed(1);

                        html += `<tr>
                            <td>${platform}</td>
                            <td>${count.toLocaleString()}</td>
                            <td>${percentage}%</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: ${percentage}%"
                                         aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                        </tr>`;
                    }

                    html += '</tbody></table></div>';

                    // Add insights section
                    html += '<h5 class="mt-4">Insights</h5>';
                    html += '<ul>';

                    // Most popular platform
                    if (sortedPlatforms.length > 0) {
                        html += `<li>The most discussed platform is <strong>${sortedPlatforms[0]}</strong> with ${platformTotals[sortedPlatforms[0]].toLocaleString()} documents (${((platformTotals[sortedPlatforms[0]] / totalDocuments) * 100).toFixed(1)}% of all discussions).</li>`;
                    }

                    // Least popular platform
                    if (sortedPlatforms.length > 1) {
                        const lastPlatform = sortedPlatforms[sortedPlatforms.length - 1];
                        html += `<li>The least discussed platform is <strong>${lastPlatform}</strong> with ${platformTotals[lastPlatform].toLocaleString()} documents (${((platformTotals[lastPlatform] / totalDocuments) * 100).toFixed(1)}% of all discussions).</li>`;
                    }

                    html += '</ul>';

                    // Update analysis results
                    $('#analysis-results').html(html);
                },
                error: function(xhr, status, error) {
                    $('#analysis-results').html(`<div class="alert alert-danger">Error generating platform comparison: ${error}</div>`);
                }
            });
        }

        // Function to find peak periods
        function findPeakPeriods() {
            // Show loading indicator
            $('#analysis-results').html('<div class="text-center"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Finding peak periods...</p></div>');

            // Get current parameters
            const query = $('#query').val() || '*:*';
            const interval = $('#interval').val();
            const platform = $('#platform').val();
            const sentiment = $('#sentiment').val();
            const startDate = $('#start_date').val();
            const endDate = $('#end_date').val();

            // Prepare filters
            const filters = [];
            if (platform) filters.push(`platform:${platform}`);
            if (sentiment) filters.push(`sentiment:${sentiment}`);
            if (startDate && endDate) {
                filters.push(`created_at:[${startDate}T00:00:00Z TO ${endDate}T23:59:59Z]`);
            }

            // Get timeline data
            $.ajax({
                url: '/api/timeline/distribution',
                data: {
                    q: query,
                    interval: interval,
                    fq: filters
                },
                success: function(data) {
                    if (!data.timeline || data.timeline.length === 0) {
                        $('#analysis-results').html('<div class="alert alert-warning">No data available to find peak periods</div>');
                        return;
                    }

                    // Sort by count to find peaks
                    const sortedData = [...data.timeline].sort((a, b) => b.count - a.count);
                    const topPeaks = sortedData.slice(0, 3);

                    // Generate HTML
                    let html = '<h4>Peak Activity Periods</h4>';
                    html += '<p>Top periods with highest discussion volume:</p>';
                    html += '<div class="table-responsive"><table class="table table-striped">';
                    html += '<thead><tr><th>Rank</th><th>Period</th><th>Document Count</th><th>Above Average</th></tr></thead>';
                    html += '<tbody>';

                    // Calculate average
                    const totalCount = data.timeline.reduce((sum, item) => sum + item.count, 0);
                    const averageCount = totalCount / data.timeline.length;

                    topPeaks.forEach((peak, index) => {
                        const percentAboveAvg = (((peak.count / averageCount) - 1) * 100).toFixed(1);

                        html += `<tr>
                            <td>${index + 1}</td>
                            <td>${formatDate(peak.date, interval)}</td>
                            <td>${peak.count.toLocaleString()}</td>
                            <td>+${percentAboveAvg}%</td>
                        </tr>`;
                    });

                    html += '</tbody></table></div>';

                    // Add insights section
                    html += '<h5 class="mt-4">Insights</h5>';
                    html += '<ul>';
                    html += `<li>The peak period was <strong>${formatDate(topPeaks[0].date, interval)}</strong> with ${topPeaks[0].count.toLocaleString()} documents, ${((topPeaks[0].count / averageCount) * 100).toFixed(1)}% of the average volume.</li>`;
                    html += `<li>The average document count per period is ${Math.round(averageCount).toLocaleString()}.</li>`;
                    html += '</ul>';

                    // Update analysis results
                    $('#analysis-results').html(html);
                },
                error: function(xhr, status, error) {
                    $('#analysis-results').html(`<div class="alert alert-danger">Error finding peak periods: ${error}</div>`);
                }
            });
        }

        // Function to find sentiment shifts
        function findSentimentShifts() {
            // Show loading indicator
            $('#analysis-results').html('<div class="text-center"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Finding sentiment shifts...</p></div>');

            // Get current parameters
            const query = $('#query').val() || '*:*';
            const interval = $('#interval').val();
            const platform = $('#platform').val();
            const startDate = $('#start_date').val();
            const endDate = $('#end_date').val();

            // Prepare filters
            const filters = [];
            if (platform) filters.push(`platform:${platform}`);
            if (startDate && endDate) {
                filters.push(`created_at:[${startDate}T00:00:00Z TO ${endDate}T23:59:59Z]`);
            }

            // Get sentiment data
            $.ajax({
                url: '/api/timeline/sentiment',
                data: {
                    q: query,
                    interval: interval,
                    fq: filters
                },
                success: function(data) {
                    if (!data.dates || data.dates.length === 0) {
                        $('#analysis-results').html('<div class="alert alert-warning">No sentiment data available to find shifts</div>');
                        return;
                    }

                    // Process the data to find sentiment shifts
                    const shifts = [];

                    for (let i = 1; i < data.dates.length; i++) {
                        // Calculate total for each period
                        const prevTotal = (data.positive[i-1] || 0) + (data.negative[i-1] || 0) + (data.neutral[i-1] || 0);
                        const currTotal = (data.positive[i] || 0) + (data.negative[i] || 0) + (data.neutral[i] || 0);

                        if (prevTotal === 0 || currTotal === 0) continue;

                        // Calculate sentiment ratios
                        const prevPosRatio = (data.positive[i-1] || 0) / prevTotal;
                        const prevNegRatio = (data.negative[i-1] || 0) / prevTotal;
                        const currPosRatio = (data.positive[i] || 0) / currTotal;
                        const currNegRatio = (data.negative[i] || 0) / currTotal;

                        // Calculate shifts
                        const posShift = currPosRatio - prevPosRatio;
                        const negShift = currNegRatio - prevNegRatio;

                        // Find significant shifts (more than 10% change)
                        if (Math.abs(posShift) > 0.1 || Math.abs(negShift) > 0.1) {
                            shifts.push({
                                fromDate: data.dates[i-1],
                                toDate: data.dates[i],
                                posShift: posShift,
                                negShift: negShift,
                                prevPosRatio: prevPosRatio,
                                prevNegRatio: prevNegRatio,
                                currPosRatio: currPosRatio,
                                currNegRatio: currNegRatio,
                                totalShift: Math.abs(posShift) + Math.abs(negShift)
                            });
                        }
                    }

                    // Sort by total shift magnitude
                    shifts.sort((a, b) => b.totalShift - a.totalShift);

                    // Generate HTML
                    let html = '<h4>Significant Sentiment Shifts</h4>';

                    if (shifts.length === 0) {
                        html += '<div class="alert alert-info">No significant sentiment shifts detected in the selected time period.</div>';
                    } else {
                        html += '<p>Periods with notable changes in sentiment distribution:</p>';
                        html += '<div class="table-responsive"><table class="table table-striped">';
                        html += '<thead><tr><th>Period Change</th><th>Positive Shift</th><th>Negative Shift</th><th>Summary</th></tr></thead>';
                        html += '<tbody>';

                        const topShifts = shifts.slice(0, 3);

                        topShifts.forEach(shift => {
                            const posShiftPct = (shift.posShift * 100).toFixed(1);
                            const negShiftPct = (shift.negShift * 100).toFixed(1);

                            let summary = '';
                            if (shift.posShift > 0.1) {
                                summary = `Sentiment became more positive (+${posShiftPct}%)`;
                            } else if (shift.negShift > 0.1) {
                                summary = `Sentiment became more negative (+${negShiftPct}%)`;
                            } else if (shift.posShift < -0.1) {
                                summary = `Sentiment became less positive (${posShiftPct}%)`;
                            } else if (shift.negShift < -0.1) {
                                summary = `Sentiment became less negative (${negShiftPct}%)`;
                            }

                            html += `<tr>
                                <td>${formatDate(shift.fromDate, interval)} to ${formatDate(shift.toDate, interval)}</td>
                                <td class="${shift.posShift > 0 ? 'text-success' : 'text-danger'}">${posShiftPct}%</td>
                                <td class="${shift.negShift > 0 ? 'text-danger' : 'text-success'}">${negShiftPct}%</td>
                                <td>${summary}</td>
                            </tr>`;
                        });

                        html += '</tbody></table></div>';

                        // Add insights section
                        html += '<h5 class="mt-4">Insights</h5>';
                        html += '<ul>';

                        if (topShifts.length > 0) {
                            const biggestShift = topShifts[0];
                            html += `<li>The most significant sentiment shift occurred from <strong>${formatDate(biggestShift.fromDate, interval)}</strong> to <strong>${formatDate(biggestShift.toDate, interval)}</strong>.</li>`;

                            if (biggestShift.posShift > 0.1) {
                                html += `<li>Positive sentiment increased from ${(biggestShift.prevPosRatio * 100).toFixed(1)}% to ${(biggestShift.currPosRatio * 100).toFixed(1)}%.</li>`;
                            } else if (biggestShift.negShift > 0.1) {
                                html += `<li>Negative sentiment increased from ${(biggestShift.prevNegRatio * 100).toFixed(1)}% to ${(biggestShift.currNegRatio * 100).toFixed(1)}%.</li>`;
                            }
                        }

                        html += '</ul>';
                    }

                    // Update analysis results
                    $('#analysis-results').html(html);
                },
                error: function(xhr, status, error) {
                    $('#analysis-results').html(`<div class="alert alert-danger">Error finding sentiment shifts: ${error}</div>`);
                }
            });
        }

        // Helper function to format dates based on interval
        function formatDate(dateStr, interval) {
            const date = new Date(dateStr);

            switch (interval) {
                case 'day':
                    return date.toLocaleDateString();
                case 'week':
                    return `Week of ${date.toLocaleDateString()}`;
                case 'month':
                    return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long' });
                case 'year':
                    return date.getFullYear().toString();
                default:
                    return dateStr;
            }
        }
    });
</script>
{% endblock %}